<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>SAT Math Concept Map</title>
<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #1e1e1e;
    color: white;
    overflow: hidden;
  }
  .map-container {
    width: 100vw;
    height: 100vh;
    position: relative;
  }
  svg {
    width: 100%;
    height: 100%;
    cursor: grab;
  }
  svg:active {
    cursor: grabbing;
  }
  .node {
    cursor: pointer;
    transition: transform 0.15s ease;
  }
  .node:hover {
    transform: scale(1.1);
  }
  .label {
    font-size: 12px;
    text-anchor: middle;
    dominant-baseline: middle;
    fill: white;
    pointer-events: none;
  }
  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.85);
    padding: 8px;
    border-radius: 6px;
    font-size: 12px;
    display: none;
    max-width: 200px;
    pointer-events: none;
    white-space: pre-line;
  }
  .side-panel {
    position: absolute;
    top: 0;
    right: -300px;
    width: 300px;
    height: 100%;
    background: #222;
    padding: 16px;
    box-shadow: -2px 0 8px rgba(0,0,0,0.5);
    transition: right 0.3s ease;
    overflow-y: auto;
  }
  .side-panel.open {
    right: 0;
  }
  .close-btn {
    background: #444;
    border: none;
    padding: 4px 8px;
    color: white;
    cursor: pointer;
    margin-bottom: 10px;
  }
  .toggle-container {
    position: absolute;
    top: 10px;
    left: 10px;
    background: rgba(34,34,34,0.85);
    padding: 6px 10px;
    border-radius: 8px;
    font-size: 14px;
    user-select: none;
  }
  input[type="range"] {
    width: 100%;
  }
</style>
</head>
<body>
<div class="map-container">
  <div class="toggle-container">
    <label>
      <input type="checkbox" id="heatmapToggle"> Heatmap
    </label>
  </div>
  <svg id="conceptMap" viewBox="0 0 2000 2000"></svg>
  <div id="tooltip" class="tooltip"></div>
  <div id="sidePanel" class="side-panel">
    <button class="close-btn" onclick="closePanel()">Close</button>
    <h2 id="panelTitle"></h2>
    <p><strong>Mastery:</strong> <span id="panelMastery"></span></p>
    <input type="range" min="0" max="100" step="5" id="masterySlider">
    <p><strong>Example:</strong> <span id="panelExample"></span></p>
    <p><strong>Description:</strong> <span id="panelSummary"></span></p>
  </div>
</div>

<script>
const topics = [
  {
    label: "Algebra & Linear Equations",
    nodes: [
      { label: "Solving Linear Equations", mastery: 0.8, example: "Solve for x: 3(x-2) = 2x + 7", summary: "Solve single-variable equations and literal equations." },
      { label: "Systems of Equations", mastery: 0.55, example: "2x + y = 10, x - y = 1", summary: "Solve systems by substitution or elimination." },
      { label: "Inequalities", mastery: 0.4, example: "Solve: 4 - 2x > 10", summary: "Solve and graph inequalities." }
    ]
  },
  {
    label: "Advanced Math",
    nodes: [
      { label: "Quadratic Equations", mastery: 0.6, example: "x² - 5x + 6 = 0", summary: "Factor, complete the square, quadratic formula." },
      { label: "Functions", mastery: 0.5, example: "f(x)=2x+3, find f(4)", summary: "Function notation, domain/range, composition." },
      { label: "Radical Expressions", mastery: 0.35, example: "Simplify: (3√18)/√2", summary: "Simplify radicals and rationalize denominators." }
    ]
  },
  {
    label: "Problem Solving & Data Analysis",
    nodes: [
      { label: "Ratios & Proportions", mastery: 0.7, example: "5 tickets $12.50, 8 tickets = ?", summary: "Unit rates and proportional relationships." },
      { label: "Statistics", mastery: 0.45, example: "Which measure is most affected by outlier?", summary: "Mean, median, mode, standard deviation." },
      { label: "Problem Solving", mastery: 0.75, example: "60→75, % increase?", summary: "Percent change, multi-step reasoning." }
    ]
  },
  {
    label: "Geometry & Trigonometry",
    nodes: [
      { label: "Triangles", mastery: 0.65, example: "Hypotenuse if legs 6 & 8", summary: "Special right triangles, Pythagoras." },
      { label: "Circles", mastery: 0.5, example: "Circle eqn: center (2,-1), r=3", summary: "Arc length, sector area, equations of circles." },
      { label: "Trigonometry", mastery: 0.3, example: "30°, opposite=5, find hypotenuse", summary: "SOH-CAH-TOA, trig in context." }
    ]
  }
];

// Load saved mastery from localStorage
topics.forEach(t => t.nodes.forEach(n => {
  const saved = localStorage.getItem(n.label);
  if (saved !== null) n.mastery = parseFloat(saved);
}));

const svg = document.getElementById("conceptMap");
const tooltip = document.getElementById("tooltip");
const sidePanel = document.getElementById("sidePanel");
const masterySlider = document.getElementById("masterySlider");
const heatmapToggle = document.getElementById("heatmapToggle");

heatmapToggle.addEventListener("change", drawMap);

function masteryColor(v, heatmap) {
  if (!heatmap) return "#888";
  if (v >= 0.75) return "#22c55e"; // green
  if (v >= 0.5) return "#eab308"; // yellow
  return "#ef4444"; // red
}

const centerX = 1000;
const centerY = 1000;

function drawMap() {
  svg.innerHTML = "";
  addCircle(centerX, centerY, 80, "#333", "SAT Math", true);

  const radius = 350;
  topics.forEach((topic, i) => {
    const angle = (i / topics.length) * 2 * Math.PI;
    const topicX = centerX + radius * Math.cos(angle);
    const topicY = centerY + radius * Math.sin(angle);

    addLine(centerX, centerY, topicX, topicY, "#666");
    addCircle(topicX, topicY, 60, "#444", topic.label);

    const subRadius = 130;
    topic.nodes.forEach((node, j) => {
      const subAngle = angle + ((j - 1) * Math.PI) / 6;
      const subX = topicX + subRadius * Math.cos(subAngle);
      const subY = topicY + subRadius * Math.sin(subAngle);

      addLine(topicX, topicY, subX, subY, "#555");
      addCircle(subX, subY, 40, masteryColor(node.mastery, heatmapToggle.checked), node.label, false, node);
    });
  });
}

function addLine(x1, y1, x2, y2, stroke) {
  const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
  line.setAttribute("x1", x1);
  line.setAttribute("y1", y1);
  line.setAttribute("x2", x2);
  line.setAttribute("y2", y2);
  line.setAttribute("stroke", stroke);
  svg.appendChild(line);
}

function addCircle(x, y, r, fill, label, isCenter = false, data = null) {
  const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
  g.setAttribute("transform", `translate(${x},${y})`);
  g.classList.add("node");

  const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
  circle.setAttribute("r", r);
  circle.setAttribute("fill", fill);
  g.appendChild(circle);

  const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
  text.setAttribute("class", "label");
  text.textContent = label;
  g.appendChild(text);

  if (data) {
    g.addEventListener("mouseenter", () => {
      tooltip.style.display = "block";
      tooltip.textContent = `${data.label}\nExample: ${data.example}`;
    });
    g.addEventListener("mousemove", (e) => {
      tooltip.style.left = e.pageX + 10 + "px";
      tooltip.style.top = e.pageY + 10 + "px";
    });
    g.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });
    g.addEventListener("click", () => openPanel(data));
  }
  svg.appendChild(g);
}

function openPanel(data) {
  document.getElementById("panelTitle").textContent = data.label;
  document.getElementById("panelMastery").textContent = Math.round(data.mastery * 100) + "%";
  masterySlider.value = Math.round(data.mastery * 100);
  masterySlider.oninput = () => {
    data.mastery = masterySlider.value / 100;
    localStorage.setItem(data.label, data.mastery);
    document.getElementById("panelMastery").textContent = masterySlider.value + "%";
    drawMap();
  };
  document.getElementById("panelExample").textContent = data.example;
  document.getElementById("panelSummary").textContent = data.summary;
  sidePanel.classList.add("open");
}

function closePanel() {
  sidePanel.classList.remove("open");
}

// Pan & zoom
let isPanning = false;
let startX, startY;
let viewBox = { x: 0, y: 0, w: 2000, h: 2000 };

svg.addEventListener("mousedown", (e) => {
  isPanning = true;
  startX = e.clientX;
  startY = e.clientY;
});
svg.addEventListener("mousemove", (e) => {
  if (!isPanning) return;
  const dx = (startX - e.clientX) * (viewBox.w / svg.clientWidth);
  const dy = (startY - e.clientY) * (viewBox.h / svg.clientHeight);
  viewBox.x += dx;
  viewBox.y += dy;
  startX = e.clientX;
  startY = e.clientY;
  updateViewBox();
});
svg.addEventListener("mouseup", () => isPanning = false);
svg.addEventListener("mouseleave", () => isPanning = false);
svg.addEventListener("wheel", (e) => {
  e.preventDefault();
  const zoomFactor = 1.1;
  if (e.deltaY < 0) {
    viewBox.w /= zoomFactor;
    viewBox.h /= zoomFactor;
  } else {
    viewBox.w *= zoomFactor;
    viewBox.h *= zoomFactor;
  }
  updateViewBox();
});

function updateViewBox() {
  svg.setAttribute("viewBox", `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
}

drawMap();
</script>
</body>
</html>
